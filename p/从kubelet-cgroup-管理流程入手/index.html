<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æ–°å¹´ç¬¬ä¸€ä¸ªflag: æ˜¥èŠ‚æœŸé—´ã€Šç¼ºæ°§ã€‹èƒ½è§£å†³æ°”ä½“å’Œæ¶²ä½“ä¾›åº”é—®é¢˜ã€‚
"><meta name=keywords content="k8s,kubelet,cgroup"><title>ä»kubelet Cgroup ç®¡ç†æµç¨‹å…¥æ‰‹</title>
<link rel=canonical href=http://blog.heyuhua.com/p/%E4%BB%8Ekubelet-cgroup-%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B%E5%85%A5%E6%89%8B/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="ä»kubelet Cgroup ç®¡ç†æµç¨‹å…¥æ‰‹"><meta property="og:description" content="æ–°å¹´ç¬¬ä¸€ä¸ªflag: æ˜¥èŠ‚æœŸé—´ã€Šç¼ºæ°§ã€‹èƒ½è§£å†³æ°”ä½“å’Œæ¶²ä½“ä¾›åº”é—®é¢˜ã€‚
"><meta property="og:url" content="http://blog.heyuhua.com/p/%E4%BB%8Ekubelet-cgroup-%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B%E5%85%A5%E6%89%8B/"><meta property="og:site_name" content="æˆ‘çš„æ—¥è®°"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2020-01-14T11:35:58+08:00"><meta property="article:modified_time" content="2020-01-14T11:35:58+08:00"><meta name=twitter:title content="ä»kubelet Cgroup ç®¡ç†æµç¨‹å…¥æ‰‹"><meta name=twitter:description content="æ–°å¹´ç¬¬ä¸€ä¸ªflag: æ˜¥èŠ‚æœŸé—´ã€Šç¼ºæ°§ã€‹èƒ½è§£å†³æ°”ä½“å’Œæ¶²ä½“ä¾›åº”é—®é¢˜ã€‚
"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/mxbc_love_hu84bcc3680e7c4ed0b569d38fde18a01e_187938_300x0_resize_box_1.gif width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ«¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>æˆ‘çš„æ—¥è®°</a></h1><h2 class=site-description>drafts.....</h2></div></header><ol class=social-menu><li><a href=https://github.com/v1c77 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://stackoverflow.com/users/6382035/vi-ci target=_blank title="Stack Overflow" rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-stackoverflow" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v1a2 2 0 002 2h12a2 2 0 002-2v-1"/><path d="M8 16h8"/><path d="M8.322 12.582l7.956.836"/><path d="M8.787 9.168l7.826 1.664"/><path d="M10.096 5.764l7.608 2.472"/></svg></a></li><li><a href=https://t.me/v1c77 target=_blank title=telegram rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4 6 6 4-16-18 7 4 2 2 6 3-4"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#å‰è¨€å¯»æ‰¾å¯èƒ½æ€§------æ··ç¼–-vm-ä¸-pod-cgroup>å‰è¨€ï¼šå¯»æ‰¾å¯èƒ½æ€§ &mdash;- æ··ç¼– VM ä¸ Pod cgroup</a></li><li><a href=#kubelet-çš„-cgroup-ç®¡ç†æ¨¡å‹>kubelet çš„ Cgroup ç®¡ç†æ¨¡å‹</a><ol><li><a href=#node-level>Node level</a></li><li><a href=#qos-level>QOS level</a></li><li><a href=#pod-level>Pod level</a></li><li><a href=#container-level>Container level</a></li></ol></li><li><a href=#å…¶ä»–ç›¸å…³ç‰¹æ€§>å…¶ä»–ç›¸å…³ç‰¹æ€§</a><ol><li><a href=#cpuset>CPUSet</a><ol><li><a href=#cpu-managerå·¥ä½œæµ>CPU Managerå·¥ä½œæµ</a></li><li><a href=#discovering-cpu-topology>Discovering CPU topology</a></li><li><a href=#åˆ›å»ºå®¹å™¨>åˆ›å»ºå®¹å™¨</a></li></ol></li></ol></li><li><a href=#å†™åœ¨æœ€å>å†™åœ¨æœ€å</a><ol><li><a href=#å‚è€ƒ>å‚è€ƒ:</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/develop/>develop</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%BB%8Ekubelet-cgroup-%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B%E5%85%A5%E6%89%8B/>ä»kubelet Cgroup ç®¡ç†æµç¨‹å…¥æ‰‹</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 14, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 10 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>æ–°å¹´ç¬¬ä¸€ä¸ªflag: æ˜¥èŠ‚æœŸé—´ã€Šç¼ºæ°§ã€‹èƒ½è§£å†³æ°”ä½“å’Œæ¶²ä½“ä¾›åº”é—®é¢˜ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº k8s è¿‘æœŸ release, git: commit 70132b0f130acc0bed193d9ba59dd186f0e634cf (HEAD, tag: v1.17.0)</p></blockquote><h2 id=å‰è¨€å¯»æ‰¾å¯èƒ½æ€§------æ··ç¼–-vm-ä¸-pod-cgroup>å‰è¨€ï¼šå¯»æ‰¾å¯èƒ½æ€§ &mdash;- æ··ç¼– VM ä¸ Pod cgroup</h2><p>æƒ³è±¡ k8s å¯ä»¥åŒæ—¶ç®¡ç† VM èµ„æºäº†
å¦‚ä½•å°† vm èµ„æºçš„cpuï¼Œå†…å­˜é…ç½®æŠ½è±¡æˆ cgroup å¹¶ä½¿ç”¨ kubelet CgroupManager ç»Ÿä¸€ç®¡ç†?</p><h2 id=kubelet-çš„-cgroup-ç®¡ç†æ¨¡å‹>kubelet çš„ Cgroup ç®¡ç†æ¨¡å‹</h2><p>kubelet ä½œä¸º k8s ç³»ç»Ÿä¸­å„ä¸ªèŠ‚ç‚¹çš„â€œè¯äº‹è€…â€ï¼Œå…¶ <code>ContainerManger</code> æ¨¡å—åŒ…æ½äº†æ‰€æœ‰çš„ cgroup ç®¡ç†å·¥ä½œã€‚
ContainerManager å°† Pod çš„ cgroup æ¨¡å‹åšäº†å±‚æ¬¡åˆ†ç¦»ï¼š container -> Pod -> Qos -> Nodeã€‚</p><h3 id=node-level>Node level</h3><p>èŠ‚ç‚¹å±‚é¢ ä¸»è¦èšç„¦äº cgroup æ¨ªå‘åˆ†é…ï¼Œ é€šè¿‡éš”ç¦»ä¸åŒç±»å‹ çš„ cgroup è¿›è¡ŒæŠ½è±¡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>                        Node Capacity
</span></span><span class=line><span class=cl>                    ---------------------------
</span></span><span class=line><span class=cl>                    |     kube-reserved       |
</span></span><span class=line><span class=cl>                    |-------------------------|
</span></span><span class=line><span class=cl>                    |     system-reserved     |
</span></span><span class=line><span class=cl>                    |-------------------------|
</span></span><span class=line><span class=cl>                    |    eviction-threshold   |
</span></span><span class=line><span class=cl>                    |-------------------------|
</span></span><span class=line><span class=cl>                    |                         |
</span></span><span class=line><span class=cl>                    |      allocatable        |
</span></span><span class=line><span class=cl>                    |   (available for pods)  |
</span></span><span class=line><span class=cl>                    |                         |
</span></span><span class=line><span class=cl>                    |                         |
</span></span><span class=line><span class=cl>                    ---------------------------
</span></span></code></pre></td></tr></table></div></div><p>é»˜è®¤æƒ…å†µä¸‹ èŠ‚ç‚¹ç²’åº¦çš„ç®¡ç† åˆ†é…äº† k8s æœåŠ¡ç»„ä»¶çš„ cgroupï¼Œ ç³»ç»Ÿéå†…æ ¸ è¿›ç¨‹ cgroupï¼Œ è¿˜æœ‰ pod èµ„æºçš„ cgroup.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>ContainerManager</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>cm</span><span class=p>.</span><span class=nf>NewContainerManager</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>Mounter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>CAdvisorInterface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cm</span><span class=p>.</span><span class=nx>NodeConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>RuntimeCgroupsName</span><span class=p>:</span>    <span class=nx>s</span><span class=p>.</span><span class=nx>RuntimeCgroups</span><span class=p>,</span> <span class=c1>// `runtime-cghroups`  é…ç½®, åˆ›å»ºå’Œè¿è¡Œå®¹å™¨è¿è¡Œæ—¶çš„ cgroup çš„ç»å¯¹åç§°
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>SystemCgroupsName</span><span class=p>:</span>     <span class=nx>s</span><span class=p>.</span><span class=nx>SystemCgroups</span><span class=p>,</span> <span class=c1>// cgroup çš„ç»å¯¹åç§°ï¼Œç”¨äºæ‰€æœ‰å°šæœªæ”¾ç½®åœ¨æ ¹ç›®å½•ä¸‹æŸ cgroup å†…çš„éå†…æ ¸è¿›ç¨‹ã€‚ç©ºå€¼è¡¨ç¤ºä¸æŒ‡å®š cgroupã€‚å›æ»šè¯¥å‚æ•°éœ€è¦é‡å¯æœºå™¨ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>KubeletCgroupsName</span><span class=p>:</span>    <span class=nx>s</span><span class=p>.</span><span class=nx>KubeletCgroups</span><span class=p>,</span> <span class=c1>// ç”¨äºåˆ›å»ºå’Œè¿è¡Œ kubelet çš„ cgroup çš„ç»å¯¹åç§°ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ContainerRuntime</span><span class=p>:</span>      <span class=nx>s</span><span class=p>.</span><span class=nx>ContainerRuntime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>CgroupsPerQOS</span><span class=p>:</span>         <span class=nx>s</span><span class=p>.</span><span class=nx>CgroupsPerQOS</span><span class=p>,</span>  <span class=c1>// å°† Pod æŒ‰ç…§ä¸åŒçš„ QOS ä¼˜å…ˆçº§è¿›è¡Œ cgroup æ‹†åˆ†ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>CgroupRoot</span><span class=p>:</span>            <span class=nx>s</span><span class=p>.</span><span class=nx>CgroupRoot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>CgroupDriver</span><span class=p>:</span>          <span class=nx>s</span><span class=p>.</span><span class=nx>CgroupDriver</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>KubeletRootDir</span><span class=p>:</span>        <span class=nx>s</span><span class=p>.</span><span class=nx>RootDirectory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ProtectKernelDefaults</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>ProtectKernelDefaults</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>NodeAllocatableConfig</span><span class=p>:</span> <span class=nx>cm</span><span class=p>.</span><span class=nx>NodeAllocatableConfig</span><span class=p>{</span> <span class=c1>// èŠ‚ç‚¹å¯åˆ†é… resource è®¡ç®—ç»“æ„ä½“
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>KubeReservedCgroupName</span><span class=p>:</span>   <span class=nx>s</span><span class=p>.</span><span class=nx>KubeReservedCgroup</span><span class=p>,</span>   <span class=c1>// k8s è‡ªèº«æœåŠ¡ æ‰€åœ¨ cgroup
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>SystemReservedCgroupName</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>SystemReservedCgroup</span><span class=p>,</span> <span class=c1>// æ“ä½œç³»ç»Ÿéå†…æ ¸è¿›ç¨‹å¤–çš„å…¶ä»–è¿›ç¨‹æ‰€åœ¨cgroup
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>EnforceNodeAllocatable</span><span class=p>:</span>   <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>EnforceNodeAllocatable</span><span class=o>...</span><span class=p>),</span> <span class=c1>// `enforce-node-allocatable` å‚æ•°è®¾ç½®ï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>KubeReserved</span><span class=p>:</span>             <span class=nx>kubeReserved</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>SystemReserved</span><span class=p>:</span>           <span class=nx>systemReserved</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>ReservedSystemCPUs</span><span class=p>:</span>       <span class=nx>reservedSystemCPUs</span><span class=p>,</span> <span class=c1>// é¢„ç•™ç»™èŠ‚ç‚¹å…¶ä»–æ— å…³è¿›ç¨‹çš„ cpu.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>HardEvictionThresholds</span><span class=p>:</span>   <span class=nx>hardEvictionThresholds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>QOSReserved</span><span class=p>:</span>                           <span class=o>*</span><span class=nx>experimentalQOSReserved</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ExperimentalCPUManagerPolicy</span><span class=p>:</span>          <span class=nx>s</span><span class=p>.</span><span class=nx>CPUManagerPolicy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ExperimentalCPUManagerReconcilePeriod</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>CPUManagerReconcilePeriod</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ExperimentalPodPidsLimit</span><span class=p>:</span>              <span class=nx>s</span><span class=p>.</span><span class=nx>PodPidsLimit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>EnforceCPULimits</span><span class=p>:</span>                      <span class=nx>s</span><span class=p>.</span><span class=nx>CPUCFSQuota</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>CPUCFSQuotaPeriod</span><span class=p>:</span>                     <span class=nx>s</span><span class=p>.</span><span class=nx>CPUCFSQuotaPeriod</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>ExperimentalTopologyManagerPolicy</span><span class=p>:</span>     <span class=nx>s</span><span class=p>.</span><span class=nx>TopologyManagerPolicy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>FailSwapOn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>devicePluginEnabled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeDeps</span><span class=p>.</span><span class=nx>Recorder</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡å¦‚ä¸Š æ¨¡å—è®¾è®¡ï¼Œ Pod çš„ allocatable resource å¯ä»¥é€šè¿‡ç®€å•çš„å‡æ³•è¿ç®—å¾—å‡º</p><blockquote><p><code>allocatable = NodeCapacity - [kube-reserved] - [system-reserved] - [eviction-threshold]</code></p></blockquote><p>æˆ‘ä»¬çš„æµ‹è¯•é›†ç¾¤ç›®å‰é…ç½®å¦‚ä¸‹ï¼š</p><ul><li>CgroupDriver : systemd</li><li>SystemCgroups: /system.slice</li><li>KubeletCgroups: /system.slice</li><li>SystemReservedCgroups: /system.slice</li><li>KubeReservedCgroups: /system.slice/kubelet.service</li></ul><p>é¢å¤–çš„ï¼š</p><ul><li>VM ç›¸å…³ cgroup é…ç½®ä½äº /system.slice/machine.sliceï¼Œ éœ€è¦çº³å…¥ nodeçš„ ç»Ÿä¸€ç®¡ç†ã€‚</li></ul><h3 id=qos-level>QOS level</h3><p>åœ¨ä¸Šä¸€èŠ‚ Node ç›¸å…³é…ç½®ä¸­ï¼Œ <code>--cgroup-per-qos</code> é…ç½®ï¼ˆé»˜è®¤ä¸º trueï¼‰ ä¼šç”Ÿæˆè¯¥å±‚çº§çš„ Cgroup é…ç½®ã€‚</p><p>ç›®å‰ QOS å…±åˆ†ä¸º 3 ç§ã€‚</p><p>qos çº§åˆ«</p><ul><li>Guaranteedã€è€æ¿ï¼ˆæˆ‘è¦çš„éƒ½æ˜¯æˆ‘çš„ï¼‰ã€‘ï¼špod é‡Œæ¯ä¸ªå®¹å™¨éƒ½å¿…é¡»è®¾å®š <code>request</code> å’Œ <code>limit</code>ï¼Œå¹¶ä¸”å€¼å¿…é¡»ç›¸åŒ</li><li>Burstable ã€æ´—ç¢—å·¥ï¼ˆåº•è–ª+ææˆï¼‰ã€‘ï¼špod é‡Œè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨çš„ cpu æˆ–è€… memory è®¾ç½®äº† <code>request</code> å€¼</li><li>BestEffortã€åˆ‡æ ¼ç“¦æ‹‰ï¼ˆèƒ½å·åˆ°çš„éƒ½æ˜¯æˆ‘çš„ï¼‰ã€‘ï¼šPOD çš„æ‰€æœ‰å®¹å™¨éƒ½æ²¡æœ‰æŒ‡å®šCPUå’Œå†…å­˜çš„ <code>request</code> å’Œ <code>limit</code></li></ul><p>åˆå§‹åŒ–è¿‡ç¨‹å‘ç”Ÿåœ¨ <code>kl.containerLogManager.Start() > setupNode</code> è¿‡ç¨‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl>	<span class=c1>// Setup top level qos containers only if CgroupsPerQOS flag is specified as true
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cm</span><span class=p>.</span><span class=nx>NodeConfig</span><span class=p>.</span><span class=nx>CgroupsPerQOS</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cm</span><span class=p>.</span><span class=nf>createNodeAllocatableCgroups</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>cm</span><span class=p>.</span><span class=nx>qosContainerManager</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>cm</span><span class=p>.</span><span class=nx>getNodeAllocatableAbsolute</span><span class=p>,</span> <span class=nx>activePods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to initialize top level QOS containers: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>createNodeAllocatableCgroups</code> ä¼šåˆå§‹åŒ– ä¸€ä¸ª <code>system.slice/kubepods.slice</code> cgroup, ç”¨äºæ”¾ç½® pod èµ„æº</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// Top level for Qos containers are created only for Burstable
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and Best Effort classes
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>qosClasses</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSClass</span><span class=p>]</span><span class=nx>CgroupName</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBurstable</span><span class=p>:</span>  <span class=nf>NewCgroupName</span><span class=p>(</span><span class=nx>rootContainer</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBurstable</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBestEffort</span><span class=p>:</span> <span class=nf>NewCgroupName</span><span class=p>(</span><span class=nx>rootContainer</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBestEffort</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Store the top level qos container names
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>m</span><span class=p>.</span><span class=nx>qosContainersInfo</span> <span class=p>=</span> <span class=nx>QOSContainersInfo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Guaranteed</span><span class=p>:</span> <span class=nx>rootContainer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Burstable</span><span class=p>:</span>  <span class=nx>qosClasses</span><span class=p>[</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBurstable</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>BestEffort</span><span class=p>:</span> <span class=nx>qosClasses</span><span class=p>[</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBestEffort</span><span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åˆå§‹åŒ–å <code>Burstable</code> å’Œ <code>BestEffort</code>ç±»å‹çš„pod cgroup ä¼šè¢«ç”Ÿæˆåœ¨ï¼Œ <code>/system.slice/kubepods.slice</code> ä¸‹ã€‚</p><p>è€Œ <code>guaranteed</code> ç±»å‹ pod ä¼šç›´æ¥ è¿è¡Œåœ¨ /system.slice/kubepods.slice ä¸‹.</p><p>è¿™é‡Œå‘ç”Ÿäº† kubelet å±‚çš„ç¬¬ä¸€æ¬¡ cgroup è®¾ç½®ï¼š <code>BestEffort</code>å…¶ä¸­çš„ cpu.shares è¢«è®¾ç½®ä¸ºminShares(=2).</p><p>è¡¨ç¤º åœ¨ cpué«˜è´Ÿè½½æƒ…å†µä¸‹ï¼Œ BestEffort. Pod å°†ä¼šäº«æœ‰ podä¸­æœ€å°‘çš„çš„cpuæ—¶é—´æ®µã€‚</p><p>åŒæ—¶ï¼Œåœ¨containerManager start ä¹‹åï¼Œ è¿˜ä¼šæœ‰ä¸€ä¸ªå¸¸é©»goç¨‹ å¾ªç¯æ‰§è¡Œ <code>UpdateCgroups()</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>qosContainerManagerImpl</span><span class=p>)</span> <span class=nf>UpdateCgroups</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>m</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>qosConfigs</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSClass</span><span class=p>]</span><span class=o>*</span><span class=nx>CgroupConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBurstable</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>               <span class=nx>m</span><span class=p>.</span><span class=nx>qosContainersInfo</span><span class=p>.</span><span class=nx>Burstable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceParameters</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>ResourceConfig</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nx>PodQOSBestEffort</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>               <span class=nx>m</span><span class=p>.</span><span class=nx>qosContainersInfo</span><span class=p>.</span><span class=nx>BestEffort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceParameters</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>ResourceConfig</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// update the qos level cgroup settings for cpu shares
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>setCPUCgroupConfig</span><span class=p>(</span><span class=nx>qosConfigs</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// update the qos level cgroup settings for huge pages (ensure they remain unbounded)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>setHugePagesConfig</span><span class=p>(</span><span class=nx>qosConfigs</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>kubefeatures</span><span class=p>.</span><span class=nx>QOSReserved</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>percentReserve</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span><span class=p>.</span><span class=nx>qosReserved</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=nx>resource</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>m</span><span class=p>.</span><span class=nf>setMemoryReserve</span><span class=p>(</span><span class=nx>qosConfigs</span><span class=p>,</span> <span class=nx>percentReserve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>updateSuccess</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>config</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>qosConfigs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>cgroupManager</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>updateSuccess</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>updateSuccess</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;[ContainerManager]: Updated QoS cgroup configuration&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// If the resource can adjust the ResourceConfig to increase likelihood of
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// success, call the adjustment function here.  Otherwise, the Update() will
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// be called again with the same values.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>percentReserve</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span><span class=p>.</span><span class=nx>qosReserved</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=nx>resource</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>m</span><span class=p>.</span><span class=nf>retrySetMemoryReserve</span><span class=p>(</span><span class=nx>qosConfigs</span><span class=p>,</span> <span class=nx>percentReserve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>config</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>qosConfigs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>cgroupManager</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;[ContainerManager]: Failed to update QoS cgroup configuration&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;[ContainerManager]: Updated QoS cgroup configuration&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯¥æµç¨‹ä¿è¯äº† kubepod ç›¸å…³metaé…ç½®ä¸è¢«ä¸²æ”¹ã€‚</p><h3 id=pod-level>Pod level</h3><p>ä¸Šä¸¤å±‚çš„ cgroup é…ç½® å¤§å¤šå±äºæ¨¡å—åˆ’åˆ†ç›¸å…³çš„å†…å®¹ï¼Œ Pod level çš„ cgroup é…ç½® åˆ™æ›´æ¥è¿‘äº k8s éœ€è¦ç€é‡äº†è§£çš„ä¸€å±‚ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Create Cgroups for the pod and apply resource parameters
</span></span><span class=line><span class=cl>// to them if cgroups-per-qos flag is enabled.
</span></span><span class=line><span class=cl>// TODO(yuhua): pod cgroup åˆ›å»º
</span></span><span class=line><span class=cl>pcm := kl.containerManager.NewPodContainerManager()
</span></span><span class=line><span class=cl>// If pod has already been terminated then we need not create
</span></span><span class=line><span class=cl>// or update the pod&#39;s cgroup
</span></span><span class=line><span class=cl>if !kl.podIsTerminated(pod) {
</span></span><span class=line><span class=cl>   // When the kubelet is restarted with the cgroups-per-qos
</span></span><span class=line><span class=cl>   // flag enabled, all the pod&#39;s running containers
</span></span><span class=line><span class=cl>   // should be killed intermittently and brought back up
</span></span><span class=line><span class=cl>   // under the qos cgroup hierarchy.
</span></span><span class=line><span class=cl>   // Check if this is the pod&#39;s first sync
</span></span><span class=line><span class=cl>   firstSync := true
</span></span><span class=line><span class=cl>   for _, containerStatus := range apiPodStatus.ContainerStatuses {
</span></span><span class=line><span class=cl>      if containerStatus.State.Running != nil {
</span></span><span class=line><span class=cl>         firstSync = false
</span></span><span class=line><span class=cl>         break
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   // Don&#39;t kill containers in pod if pod&#39;s cgroups already
</span></span><span class=line><span class=cl>   // exists or the pod is running for the first time
</span></span><span class=line><span class=cl>   podKilled := false
</span></span><span class=line><span class=cl>   if !pcm.Exists(pod) &amp;&amp; !firstSync {
</span></span><span class=line><span class=cl>      if err := kl.killPod(pod, nil, podStatus, nil); err == nil {
</span></span><span class=line><span class=cl>         podKilled = true
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   // Create and Update pod&#39;s Cgroups
</span></span><span class=line><span class=cl>   // Don&#39;t create cgroups for run once pod if it was killed above
</span></span><span class=line><span class=cl>   // The current policy is not to restart the run once pods when
</span></span><span class=line><span class=cl>   // the kubelet is restarted with the new flag as run once pods are
</span></span><span class=line><span class=cl>   // expected to run only once and if the kubelet is restarted then
</span></span><span class=line><span class=cl>   // they are not expected to run again.
</span></span><span class=line><span class=cl>   // We don&#39;t create and apply updates to cgroup if its a run once pod and was killed above
</span></span><span class=line><span class=cl>   if !(podKilled &amp;&amp; pod.Spec.RestartPolicy == v1.RestartPolicyNever) {
</span></span><span class=line><span class=cl>      if !pcm.Exists(pod) {
</span></span><span class=line><span class=cl>         if err := kl.containerManager.UpdateQOSCgroups(); err != nil {
</span></span><span class=line><span class=cl>            klog.V(2).Infof(&#34;Failed to update QoS cgroups while syncing pod: %v&#34;, err)
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl>         if err := pcm.EnsureExists(pod); err != nil {
</span></span><span class=line><span class=cl>            kl.recorder.Eventf(pod, v1.EventTypeWarning, events.FailedToCreatePodContainer, &#34;unable to ensure pod container exists: %v&#34;, err)
</span></span><span class=line><span class=cl>            return fmt.Errorf(&#34;failed to ensure that the pod: %v cgroups exist and are correctly applied: %v&#34;, pod.UID, err)
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°æµç¨‹æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ å¦‚ä¸‹å‡ ä¸ªæµç¨‹</p><blockquote><p>syncPod -> kl.containerManager.NewPodContainerManager() -> pcm.Exists(pod) -> kl.containerManager.UpdateQOSCgroups()</p></blockquote><p><code>NewPodContainerManager</code> å¹¶æ²¡æœ‰å®è´¨æ€§çš„cgroupæ“ä½œï¼Œç´§è·Ÿç€çš„åˆ¤æ–­ <code>Exists(pod)</code>-> <code>GetPodContainerName</code>å‡½æ•°è°ƒç”¨ä¼šå°è¯•è·å– å½“å‰ podåº”å½“å­˜åœ¨çš„ cgroupè·¯å¾„ã€‚å¹¶æ£€æŸ¥ pod å¯¹åº”cgroupçš„å­˜åœ¨ã€‚</p><p>å¦‚æœå‘ç°ä¸å­˜åœ¨ å¯¹åº”cgroup åˆ™è¿›å…¥åˆ›å»ºæµç¨‹ ã€åˆ›å»ºcgroup å‘ç”Ÿåœ¨ podå…¶ä»–èµ„æºåˆ›å»ºå‰ã€‘ï¼Œ å³ <code>UpdateQOSChroups</code>:</p><p>è¿˜å‡½æ•°ä¼šè¿›è¡Œï¼š</p><ul><li><code>setCPUCgroupConfig</code> æ¯”å¦‚è¯´ä¿è¯ BestEffort pod cpu share =2; è®¡ç®— Burst.slice è·¯å¾„ cpu shares è®¾ç½®åº”è¯¥ä¸º <strong>æ‰€æœ‰ burstable_pod_CPU_request</strong> çš„å’Œã€‚</li></ul><ul><li><code>setMemoryReserve</code> å–å†³äºæ˜¯å¦å¼€å¯äº†ç‰¹æ€§åŠŸèƒ½ <strong>QOSReserved</strong>, è¯¥åŠŸèƒ½ä¼šä¸º <strong>Burstable</strong> å’Œ <strong>BestEffort</strong> pod slice è®¾ç½® å¯ç”¨å†…å­˜ä¸Šé™ï¼Œ åŸºäºå®æ—¶è®¡ç®—çš„å„ä¸ªç±»å‹çš„ podçš„ å†…å­˜ä½¿ç”¨çŠ¶å†µã€‚ ã€æš‚å®šé»˜è®¤å…³é—­ã€‘</li><li><code>setHugePagesConfig</code> æ ¹æ®åŠŸèƒ½å¼€å…³è®¾ç½® hugepage ç”¨é‡ã€‚ã€æš‚å®šé»˜è®¤å…³é—­ã€‘</li></ul><p>ä¸Šè¿°åŠ¨ä½œå®Œæˆå å°†ä¼šæ‰§è¡Œ pod ç²’åº¦ çš„ cgroup åˆ›å»ºï¼Œ æ›´æ–°æ“ä½œ <code>EnsureExists</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>EnsureExists</span> <span class=n>takes</span> <span class=n>a</span> <span class=n>pod</span> <span class=n>as</span> <span class=n>argument</span> <span class=ow>and</span> <span class=n>makes</span> <span class=n>sure</span> <span class=n>that</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>pod</span> <span class=n>cgroup</span> <span class=n>exists</span> <span class=k>if</span> <span class=n>qos</span> <span class=n>cgroup</span> <span class=n>hierarchy</span> <span class=n>flag</span> <span class=n>is</span> <span class=n>enabled</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>pod</span> <span class=n>level</span> <span class=n>container</span> <span class=n>doesn</span><span class=s1>&#39;t already exist it is created.</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>m</span> <span class=o>*</span><span class=n>podContainerManagerImpl</span><span class=p>)</span> <span class=n>EnsureExists</span><span class=p>(</span><span class=n>pod</span> <span class=o>*</span><span class=n>v1</span><span class=o>.</span><span class=n>Pod</span><span class=p>)</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>podContainerName</span><span class=p>,</span> <span class=n>_</span> <span class=p>:</span><span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>GetPodContainerName</span><span class=p>(</span><span class=n>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>check</span> <span class=k>if</span> <span class=n>container</span> <span class=n>already</span> <span class=n>exist</span>
</span></span><span class=line><span class=cl>	<span class=n>alreadyExists</span> <span class=p>:</span><span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>Exists</span><span class=p>(</span><span class=n>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>!</span><span class=n>alreadyExists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>Create</span> <span class=n>the</span> <span class=n>pod</span> <span class=n>container</span>
</span></span><span class=line><span class=cl>		<span class=n>containerConfig</span> <span class=p>:</span><span class=o>=</span> <span class=o>&amp;</span><span class=n>CgroupConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Name</span><span class=p>:</span>               <span class=n>podContainerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>ResourceParameters</span><span class=p>:</span> <span class=n>ResourceConfigForPod</span><span class=p>(</span><span class=n>pod</span><span class=p>,</span> <span class=n>m</span><span class=o>.</span><span class=n>enforceCPULimits</span><span class=p>,</span> <span class=n>m</span><span class=o>.</span><span class=n>cpuCFSQuotaPeriod</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>utilfeature</span><span class=o>.</span><span class=n>DefaultFeatureGate</span><span class=o>.</span><span class=n>Enabled</span><span class=p>(</span><span class=n>kubefeatures</span><span class=o>.</span><span class=n>SupportPodPidsLimit</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>m</span><span class=o>.</span><span class=n>podPidsLimit</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>containerConfig</span><span class=o>.</span><span class=n>ResourceParameters</span><span class=o>.</span><span class=n>PidsLimit</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>m</span><span class=o>.</span><span class=n>podPidsLimit</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>cgroupManager</span><span class=o>.</span><span class=n>Create</span><span class=p>(</span><span class=n>containerConfig</span><span class=p>);</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>fmt</span><span class=o>.</span><span class=n>Errorf</span><span class=p>(</span><span class=s2>&#34;failed to create container for %v : %v&#34;</span><span class=p>,</span> <span class=n>podContainerName</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>Apply</span> <span class=n>appropriate</span> <span class=n>resource</span> <span class=n>limits</span> <span class=n>on</span> <span class=n>the</span> <span class=n>pod</span> <span class=n>container</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>Top</span> <span class=n>level</span> <span class=n>qos</span> <span class=n>containers</span> <span class=n>limits</span> <span class=n>are</span> <span class=ow>not</span> <span class=n>updated</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>until</span> <span class=n>we</span> <span class=n>figure</span> <span class=n>how</span> <span class=n>to</span> <span class=n>maintain</span> <span class=n>the</span> <span class=n>desired</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>kubelet</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>Because</span> <span class=n>maintaining</span> <span class=n>the</span> <span class=n>desired</span> <span class=n>state</span> <span class=n>is</span> <span class=n>difficult</span> <span class=n>without</span> <span class=n>checkpointing</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>applyLimits</span><span class=p>(</span><span class=n>pod</span><span class=p>);</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>fmt</span><span class=o>.</span><span class=n>Errorf</span><span class=p>(</span><span class=s2>&#34;failed to apply resource limits on container for %v : %v&#34;</span><span class=p>,</span> <span class=n>podContainerName</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°ä»£ç ä¸­ <code>m.cgroupManager.Create(containerConfig</code> å¯ä»¥å®Œæˆ pod çº§åˆ«çš„ cgroupåˆ›å»ºï¼Œ è‡³æ­¤æˆ‘ä»¬çš„ pod cgroup container å·²ç»åˆå…·é›å½¢ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@node1<span class=o>]</span><span class=c1># tree /sys/fs/cgroup/cpu -d</span>
</span></span><span class=line><span class=cl>/sys/fs/cgroup/cpu
</span></span><span class=line><span class=cl>â”œâ”€â”€ kubepods
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ besteffort
</span></span><span class=line><span class=cl>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pode098d78945a4d359594f9c27066aa202
</span></span><span class=line><span class=cl>â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 5fca7a73d4b5c7e7a6c35415e2bfeb5533c5fc1d1b4aa80bc4cb641213ee29a3
</span></span><span class=line><span class=cl>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ b10831a7a2cf4e96ff6b186396e9e393e5b02aa8c447e988cc6cca5172fc5c89
</span></span><span class=line><span class=cl>â”‚Â Â  â”‚Â Â  â””â”€â”€ podfc7fbc35-bb79-4a33-80a0-371d438f221e
</span></span><span class=line><span class=cl>â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 07703a4a76b926c8432c3a8ab50b69b8dfd2891733a09d830fc1a08f8a8e0a1c
</span></span><span class=line><span class=cl>â”‚Â Â  â”‚Â Â      â””â”€â”€ 3a7550ae2bd7784bc7f74fa0288d361e6d569595a0ba237bb63cdd5468073316
</span></span><span class=line><span class=cl>â”‚Â Â  â””â”€â”€ burstable
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ pod420984c2d6d62f72216bba6857bc368b
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 5f734d0677fb4dd0f3e3dd3647be6ad19ec728fd3e28860c6023ea6efb7fc331
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â””â”€â”€ 93cd418eaddf86be58b200c109674a36cc04fee0eccfae4a7838a1b0e6a4f978
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ pod4ebb633e-f8ba-43ee-94c7-1cf8c9105555
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â””â”€â”€ 1bc40d00174d3ea84f4fce14d734a45115e72e4af394bd7d684d9691e7749995
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ podcd4bc68a-faf3-4c08-8d07-57d25a68ee1b
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 62ba8b7c6e1afc62d16b65e0d0ae9f82254260815025ecb6c863fa82c9ea5e8e
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â””â”€â”€ c7aca0c0fdf230a6378e3325f03242ff561ec95e7f62b3b852f2877af0235792
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ podd4f2a7d434e44edd8e4a0960111bda9f
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 08d95544fcd3a5631c5a6a550d42bcddf8319cfb1fbe7f2482d969fc19356466
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â””â”€â”€ a7a39f33fddce54c64c4a6d0bf4b499fe3d6b3d7c7f5fc0d54445ade5cad24b1
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ pode8486b59c2c8408b07026a560746b02c
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â”œâ”€â”€ b9fb9af9f1c5991786c6457f5b33c90ee8e33a3d68605d409b7a2c30d5565699
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â””â”€â”€ f7f6773069032faa45ef3fc62fe337127fe40795ebc3758d03e149376d18d3da
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ pode86c3e73-a96e-4ae8-9ff6-fd401cf5c9aa
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â”œâ”€â”€ 4ad31b5ea0ad5743eeb67628c3bf9275d2131f2132a4bbe7081c05f63c6604ea
</span></span><span class=line><span class=cl>â”‚Â Â      â”‚Â Â  â””â”€â”€ 5f31deed41c58dbc0a0530b964926968d272e846cf9d91452c40797ace7fb90a
</span></span><span class=line><span class=cl>â”‚Â Â      â””â”€â”€ podf27baf8c-6c71-4f3a-9445-0c63eb33d586
</span></span><span class=line><span class=cl>â”‚Â Â          â”œâ”€â”€ 1ae1d0d1fb0d44652c8ad8ef2d782628ec04a7b0e6e5718ea6788af178505ba2
</span></span><span class=line><span class=cl>â”‚Â Â          â””â”€â”€ 5e898be28b1cb5ccb7f9f52eddee06c114d7d42b951b256da5544128093216be
</span></span><span class=line><span class=cl>â”œâ”€â”€ machine.slice
</span></span><span class=line><span class=cl>â”‚Â Â  â””â”€â”€ machine-qemu<span class=se>\\</span>x2d18<span class=se>\\</span>x2dvm123.scope
</span></span><span class=line><span class=cl>â”‚Â Â      â”œâ”€â”€ emulator
</span></span><span class=line><span class=cl>â”‚Â Â      â””â”€â”€ vcpu0
</span></span><span class=line><span class=cl>â”œâ”€â”€ system.slice
</span></span><span class=line><span class=cl>â””â”€â”€ user.slice
</span></span></code></pre></td></tr></table></div></div><blockquote><p><code>machine.slice</code> æ˜¯ libvirt é’ˆå¯¹æ¯ä¸ª qemu è¿›ç¨‹ç”Ÿæˆçš„ cgroupç®¡ç†ç©ºé—´. æˆ‘ä»¬æ„åœ¨å°†å…¶çº³å…¥ k8s cgoup ç»Ÿè®¡èŒƒå›´å†…ã€‚</p></blockquote><h3 id=container-level>Container level</h3><p>ä¸Šè¿° Node level å‘ç”Ÿåœ¨ kubelet çš„ SyncPod å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ åŒæ ·çš„ï¼Œ container ç›¸å…³çš„ cgroupåˆ›å»º ä¹Ÿæ˜¯åœ¨è¿™ä¹‹åã€‚</p><p>æ•…äº‹ä»ç„¶è¦ä»pod åˆ›å»ºè¯·æ±‚å¼€å§‹ï¼Œ ä» å…¥å£å¤„çš„ kubelet <code>syncLoop</code> -> <code>syncLoopIteration</code> -> <code>HandlePodAddtions</code> -> <code>dispatchWork</code> -> <code>UpdatePod</code> -> <code>managePodLoop</code> -> <code>SyncPod</code> -> <code>kl.containerRuntime.SyncPod</code></p><p>è¿›å…¥ çœŸæ­£åˆ›å»º containeræµç¨‹ï¼Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>SyncPod</span> <span class=n>syncs</span> <span class=n>the</span> <span class=n>running</span> <span class=n>pod</span> <span class=n>into</span> <span class=n>the</span> <span class=n>desired</span> <span class=n>pod</span> <span class=n>by</span> <span class=n>executing</span> <span class=n>following</span> <span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>//</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>1.</span> <span class=n>Compute</span> <span class=n>sandbox</span> <span class=ow>and</span> <span class=n>container</span> <span class=n>changes</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>2.</span> <span class=n>Kill</span> <span class=n>pod</span> <span class=n>sandbox</span> <span class=k>if</span> <span class=n>necessary</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>3.</span> <span class=n>Kill</span> <span class=n>any</span> <span class=n>containers</span> <span class=n>that</span> <span class=n>should</span> <span class=ow>not</span> <span class=n>be</span> <span class=n>running</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>4.</span> <span class=n>Create</span> <span class=n>sandbox</span> <span class=k>if</span> <span class=n>necessary</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>5.</span> <span class=n>Create</span> <span class=n>ephemeral</span> <span class=n>containers</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>6.</span> <span class=n>Create</span> <span class=n>init</span> <span class=n>containers</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>  <span class=mf>7.</span> <span class=n>Create</span> <span class=n>normal</span> <span class=n>containers</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>TODO</span><span class=p>(</span><span class=n>yuhua</span><span class=p>):</span> <span class=err>åˆ›å»º</span><span class=n>container</span> <span class=err>ä¹‹å¤„ã€‚</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>m</span> <span class=o>*</span><span class=n>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=n>SyncPod</span><span class=p>(</span><span class=n>pod</span> <span class=o>*</span><span class=n>v1</span><span class=o>.</span><span class=n>Pod</span><span class=p>,</span> <span class=n>podStatus</span> <span class=o>*</span><span class=n>kubecontainer</span><span class=o>.</span><span class=n>PodStatus</span><span class=p>,</span> <span class=n>pullSecrets</span> <span class=p>[]</span><span class=n>v1</span><span class=o>.</span><span class=n>Secret</span><span class=p>,</span> <span class=n>backOff</span> <span class=o>*</span><span class=n>flowcontrol</span><span class=o>.</span><span class=n>Backoff</span><span class=p>)</span> <span class=p>(</span><span class=n>result</span> <span class=n>kubecontainer</span><span class=o>.</span><span class=n>PodSyncResult</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>containerRuntime.SyncPod ä¸»è¦å†…å®¹æ¶‰åŠåˆ° å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p><ul><li>è®¡ç®— sandbox å’Œ container å˜åŒ–</li><li>åˆ é™¤æ— ç”¨sandbox</li><li>åˆ é™¤æ— ç”¨ å®¹å™¨</li><li>åˆ›å»ºæ²™ç®±</li><li>åˆ›å»º ä¸€æ¬¡æ€§å®¹å™¨</li><li>åˆ›å»º åˆå§‹åŒ–å®¹å™¨</li><li>åˆ›å»º å…¶ä»–å®¹å™¨ã€‚</li></ul><p>ä¸Šè¿°å‰4æ­¥éƒ½ä¸ cgroupæ— å…³ï¼Œè¿™é‡Œæœ€åçš„ä¸‰ä¸ªåˆ›å»ºæ­¥éª¤ éƒ½ä½¿ç”¨äº† ä¸€äº›å…¬ç”¨é€»è¾‘ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Helper containing boilerplate common to starting all types of containers.
</span></span><span class=line><span class=cl>// typeName is a label used to describe this type of container in log messages,
</span></span><span class=line><span class=cl>// currently: &#34;container&#34;, &#34;init container&#34; or &#34;ephemeral container&#34;
</span></span><span class=line><span class=cl>start := func(typeName string, container *v1.Container) error {
</span></span><span class=line><span class=cl>	startContainerResult := kubecontainer.NewSyncResult(kubecontainer.StartContainer, container.Name)
</span></span><span class=line><span class=cl>	result.AddSyncResult(startContainerResult)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>isInBackOff, msg, err := m.doBackOff(pod, container, podStatus, backOff)
</span></span><span class=line><span class=cl>if isInBackOff {
</span></span><span class=line><span class=cl>	startContainerResult.Fail(err, msg)
</span></span><span class=line><span class=cl>	klog.V(4).Infof(&#34;Backing Off restarting %v %+v in pod %v&#34;, typeName, container, format.Pod(pod))
</span></span><span class=line><span class=cl>	return err
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>klog.V(4).Infof(&#34;Creating %v %+v in pod %v&#34;, typeName, container, format.Pod(pod))
</span></span><span class=line><span class=cl>// NOTE (aramase) podIPs are populated for single stack and dual stack clusters. Send only podIPs.
</span></span><span class=line><span class=cl>if msg, err := m.startContainer(podSandboxID, podSandboxConfig, container, pod, podStatus, pullSecrets, podIP, podIPs); err != nil {
</span></span><span class=line><span class=cl>	startContainerResult.Fail(err, msg)
</span></span><span class=line><span class=cl>	// known errors that are logged in other places are logged at higher levels here to avoid
</span></span><span class=line><span class=cl>	// repetitive log spam
</span></span><span class=line><span class=cl>	switch {
</span></span><span class=line><span class=cl>	case err == images.ErrImagePullBackOff:
</span></span><span class=line><span class=cl>		klog.V(3).Infof(&#34;%v start failed: %v: %s&#34;, typeName, err, msg)
</span></span><span class=line><span class=cl>	default:
</span></span><span class=line><span class=cl>		utilruntime.HandleError(fmt.Errorf(&#34;%v start failed: %v: %s&#34;, typeName, err, msg))
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>	return err
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œåªéœ€è¦å…³æ³¨ <code>startContainer</code> ç›¸å…³é€»è¾‘ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>startContainer</span> <span class=n>starts</span> <span class=n>a</span> <span class=n>container</span> <span class=ow>and</span> <span class=n>returns</span> <span class=n>a</span> <span class=n>message</span> <span class=n>indicates</span> <span class=n>why</span> <span class=n>it</span> <span class=n>is</span> <span class=n>failed</span> <span class=n>on</span> <span class=n>error</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>It</span> <span class=n>starts</span> <span class=n>the</span> <span class=n>container</span> <span class=n>through</span> <span class=n>the</span> <span class=n>following</span> <span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=o>*</span> <span class=n>pull</span> <span class=n>the</span> <span class=n>image</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=o>*</span> <span class=n>create</span> <span class=n>the</span> <span class=n>container</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=o>*</span> <span class=n>start</span> <span class=n>the</span> <span class=n>container</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=o>*</span> <span class=n>run</span> <span class=n>the</span> <span class=n>post</span> <span class=n>start</span> <span class=n>lifecycle</span> <span class=n>hooks</span> <span class=p>(</span><span class=k>if</span> <span class=n>applicable</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>m</span> <span class=o>*</span><span class=n>kubeGenericRuntimeManager</span><span class=p>)</span> <span class=n>startContainer</span><span class=p>(</span><span class=n>podSandboxID</span> <span class=n>string</span><span class=p>,</span> <span class=n>podSandboxConfig</span> <span class=o>*</span><span class=n>runtimeapi</span><span class=o>.</span><span class=n>PodSandboxConfig</span><span class=p>,</span> <span class=n>container</span> <span class=o>*</span><span class=n>v1</span><span class=o>.</span><span class=n>Container</span><span class=p>,</span> <span class=n>pod</span> <span class=o>*</span><span class=n>v1</span><span class=o>.</span><span class=n>Pod</span><span class=p>,</span> <span class=n>podStatus</span> <span class=o>*</span><span class=n>kubecontainer</span><span class=o>.</span><span class=n>PodStatus</span><span class=p>,</span> <span class=n>pullSecrets</span> <span class=p>[]</span><span class=n>v1</span><span class=o>.</span><span class=n>Secret</span><span class=p>,</span> <span class=n>podIP</span> <span class=n>string</span><span class=p>,</span> <span class=n>podIPs</span> <span class=p>[]</span><span class=n>string</span><span class=p>)</span> <span class=p>(</span><span class=n>string</span><span class=p>,</span> <span class=n>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„ <code>podSandboxConfig</code> åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>Linux</span>                <span class=o>*</span><span class=nx>LinuxPodSandboxConfig</span> <span class=s>`protobuf:&#34;bytes,8,opt,name=linux,proto3&#34; json:&#34;linux,omitempty&#34;`</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// LinuxPodSandboxConfig holds platform-specific configurations for Linux
</span></span><span class=line><span class=cl>// host platforms and Linux-based containers.
</span></span><span class=line><span class=cl>type LinuxPodSandboxConfig struct {
</span></span><span class=line><span class=cl>	// Parent cgroup of the PodSandbox.
</span></span><span class=line><span class=cl>	// The cgroupfs style syntax will be used, but the container runtime can
</span></span><span class=line><span class=cl>	// convert it to systemd semantics if needed.
</span></span><span class=line><span class=cl>	CgroupParent string `protobuf:&#34;bytes,1,opt,name=cgroup_parent,json=cgroupParent,proto3&#34; json:&#34;cgroup_parent,omitempty&#34;`
</span></span><span class=line><span class=cl>	// LinuxSandboxSecurityContext holds sandbox security attributes.
</span></span><span class=line><span class=cl>	SecurityContext *LinuxSandboxSecurityContext `protobuf:&#34;bytes,2,opt,name=security_context,json=securityContext,proto3&#34; json:&#34;security_context,omitempty&#34;`
</span></span><span class=line><span class=cl>	// Sysctls holds linux sysctls config for the sandbox.
</span></span><span class=line><span class=cl>	Sysctls              map[string]string `protobuf:&#34;bytes,3,rep,name=sysctls,proto3&#34; json:&#34;sysctls,omitempty&#34; protobuf_key:&#34;bytes,1,opt,name=key,proto3&#34; protobuf_val:&#34;bytes,2,opt,name=value,proto3&#34;`
</span></span><span class=line><span class=cl>	XXX_NoUnkeyedLiteral struct{}          `json:&#34;-&#34;`
</span></span><span class=line><span class=cl>	XXX_sizecache        int32             `json:&#34;-&#34;`
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ° CgroupParent é™åˆ¶äº† cgroupåˆ›å»ºçš„ çˆ¶è·¯å¾„ã€‚ è‡³æ­¤ k8s å±‚çš„cgroupåˆ›å»ºè¿‡ç¨‹ç»“æŸã€‚</p><p>åˆ›å»ºç»“æŸåçš„ cgroupæ‹“æ‰‘å‚è€ƒ Nodeç« èŠ‚ç»“æœã€‚</p><h2 id=å…¶ä»–ç›¸å…³ç‰¹æ€§>å…¶ä»–ç›¸å…³ç‰¹æ€§</h2><h3 id=cpuset>CPUSet</h3><p>å½“ VM ä¸ Pod è¿›è¡Œæ··åˆç¼–æ’ï¼Œ è™šæ‹ŸåŒ–è¯­ä¹‰ä¸­çš„ vcpu pin å¯ä»¥ä½¿ç”¨ cgroup çš„ cpu_set ä½œä¸º åŠŸèƒ½æ˜ å°„</p><p>k8s ä¸­ feature Gate <code>CPUManager </code>è´Ÿè´£ ç®¡ç† å®¹å™¨çš„ cpu set è®¾ç½® è¯¥åŠŸèƒ½ åœ¨ k8s 1.8 è¿›å…¥ alpha, åœ¨ 1.10 å betaï¼Œ ç›®å‰ ï¼ˆk8s 1.17ï¼‰ ä»ç„¶å±äº beta çŠ¶æ€ã€‚</p><h4 id=cpu-managerå·¥ä½œæµ>CPU Managerå·¥ä½œæµ</h4><p>CPU Managerä¸ºæ»¡è¶³æ¡ä»¶çš„Containeråˆ†é…æŒ‡å®šçš„CPUsæ—¶ï¼Œä¼šå°½é‡æŒ‰ç…§CPU Topologyæ¥åˆ†é…ï¼Œä¹Ÿå°±æ˜¯è€ƒè™‘CPU Affinityï¼ŒæŒ‰ç…§å¦‚ä¸‹çš„ä¼˜å…ˆé¡ºåºè¿›è¡ŒCPUsé€‰æ‹©ï¼šï¼ˆLogic CPUså°±æ˜¯Hyperthreadsï¼‰</p><ol><li>å¦‚æœContainerè¯·æ±‚çš„Logic CPUsæ•°é‡ä¸å°äºå•å—CPU Socketä¸­Logci CPUsæ•°é‡ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆæŠŠæ•´å—CPU Socketä¸­çš„Logic CPUsåˆ†é…ç»™è¯¥Containerã€‚</li><li>å¦‚æœContainerå‰©ä½™è¯·æ±‚çš„Logic CPUsæ•°é‡ä¸å°äºå•å—ç‰©ç†CPU Coreæä¾›çš„Logic CPUsæ•°é‡ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆæŠŠæ•´å—ç‰©ç†CPU Coreä¸Šçš„Logic CPUsåˆ†é…ç»™è¯¥Containerã€‚</li><li>Containerå‰©ä½™è¯·æ±‚çš„Logic CPUsåˆ™ä»æŒ‰ç…§å¦‚ä¸‹è§„åˆ™æ’å¥½åºçš„Logic CPUsåˆ—è¡¨ä¸­é€‰æ‹©ï¼š</li></ol><ul><li>number of CPUs available on the same socket</li><li>number of CPUs available on the same core</li></ul><h4 id=discovering-cpu-topology>Discovering CPU topology</h4><p>CPU Managerèƒ½æ­£å¸¸å·¥ä½œçš„å‰æï¼Œæ˜¯å‘ç°Nodeä¸Šçš„CPU Topologyï¼ŒDiscoveryè¿™éƒ¨åˆ†å·¥ä½œæ˜¯ç”±cAdvisorå®Œæˆçš„ã€‚</p><p>åœ¨cAdvisorçš„MachineInfoä¸­é€šè¿‡Topologyä¼šè®°å½•cpuå’Œmemçš„Topologyä¿¡æ¯ã€‚å…¶ä¸­Topologyçš„æ¯ä¸ªNodeå¯¹è±¡å°±æ˜¯å¯¹åº”ä¸€ä¸ªCPU Socketã€‚</p><h4 id=åˆ›å»ºå®¹å™¨>åˆ›å»ºå®¹å™¨</h4><p>å¯¹äºæ»¡è¶³å‰é¢æåˆ°çš„æ»¡è¶³static policyçš„Containeråˆ›å»ºæ—¶ï¼Œkubeletä¼šä¸ºå…¶æŒ‰ç…§çº¦å®šçš„cpu affinityæ¥ä¸ºå…¶æŒ‘é€‰æœ€ä¼˜çš„CPU Setã€‚Containerçš„åˆ›å»ºæ—¶CPU Managerå·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li><p>Kuberuntimeè°ƒç”¨å®¹å™¨è¿è¡Œæ—¶å»åˆ›å»ºè¯¥Containerã€‚</p></li><li><p>Kuberuntimeå°†è¯¥Containeräº¤ç»™CPU Managerå¤„ç†ã€‚</p></li><li><p>CPU Managerä¸ºContaineræŒ‰ç…§static policyé€»è¾‘è¿›è¡Œå¤„ç†ã€‚</p></li><li><p>CPU Managerä»å½“å‰Shared Poolä¸­æŒ‘é€‰â€œæœ€ä½³â€Setæ‹“æ‰‘ç»“æ„çš„CPUï¼Œå¯¹äºä¸æ»¡è¶³Static Policyçš„Contianerï¼Œåˆ™è¿”å›Shared Poolä¸­æ‰€æœ‰CPUSç»„æˆçš„Setã€‚</p></li><li><p>CPU Managerå°†å¯¹è¯¥Containerçš„CPUsåˆ†é…æƒ…å†µè®°å½•åˆ°Checkpoint Stateä¸­ï¼Œå¹¶ä¸”ä»Shared Poolä¸­åˆ é™¤åˆšåˆ†é…çš„CPUsã€‚</p></li><li><p>CPU Managerå†ä»stateä¸­è¯»å–è¯¥Containerçš„CPUåˆ†é…ä¿¡æ¯ï¼Œç„¶åé€šè¿‡UpdateContainerResources cRIæ¥å£å°†å…¶æ›´æ–°åˆ°Cpuset Cgroupsä¸­ï¼ŒåŒ…æ‹¬å¯¹äºéStatic Policy Containerã€‚</p></li><li><p>Kuberuntimeè°ƒç”¨å®¹å™¨è¿è¡Œæ—¶Startè¯¥å®¹å™¨ã€‚</p></li></ol><p>è¯¥è¿‡ç¨‹å…¥å£å¤„äº ä¸Šä¸€ç« èŠ‚çš„ Container level ä¸­çš„ <code>startContainer</code> å‡½æ•°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	// TODO(yuhua): è®¾ç½® CPUset
</span></span><span class=line><span class=cl>	err = m.internalLifecycle.PreStartContainer(pod, container, containerID)
</span></span><span class=line><span class=cl>	if err != nil {
</span></span><span class=line><span class=cl>		s, _ := grpcstatus.FromError(err)
</span></span><span class=line><span class=cl>		m.recordContainerEvent(pod, container, containerID, v1.EventTypeWarning, events.FailedToStartContainer, &#34;Internal PreStartContainer hook failed: %v&#34;, s.Message())
</span></span><span class=line><span class=cl>		return s.Message(), ErrPreStartHook
</span></span><span class=line><span class=cl>	}
</span></span></code></pre></td></tr></table></div></div><h2 id=å†™åœ¨æœ€å>å†™åœ¨æœ€å</h2><p>libvirt å·²ç»å®ç°äº†å®Œæ•´çš„ cgroup æŠ½è±¡ï¼Œ ä½†æ˜¯ç¼ºå°‘å®Œæ•´çš„ cgroup ç®¡ç†æµç¨‹ï¼Œå¦‚æœæƒ³è¦é€šè¿‡ cgroupå°† vm èµ„æºæŠ½è±¡ å¹¶ä¸ Pod çš„èµ„æºåšç»Ÿä¸€ç®¡ç†ï¼Œ æˆ‘ä»¬åœ¨å‰ç«¯ ï¼ˆkubeletï¼‰ åŠ å¯¹åº”çš„ åç«¯ ï¼ˆVRIï¼‰ è®¾è®¡å®Œæ•´çš„ cgroup æ“ä½œæµç¨‹ã€‚</p><h3 id=å‚è€ƒ>å‚è€ƒ:</h3><ol><li><a class=link href=https://github.com/kubernetes/kubernetes target=_blank rel=noopener>k8s</a></li><li><a class=link href=https://cloud.tencent.com/developer/article/1402119 target=_blank rel=noopener>cpu manager</a></li><li><a class=link href=https://libvirt.org/cgroups.html target=_blank rel=noopener>libvirt cgroups</a></li></ol></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/vertical-scaling-of-pods-pod%E7%83%AD%E7%BC%A9%E6%94%BE/><div class=article-details><h2 class=article-title>Vertical Scaling of Pods | podçƒ­ç¼©æ”¾</h2></div></a></article><article><a href=/p/python%E9%87%8D%E4%BF%AE%E4%B9%8B%E6%97%85%E4%BA%94/><div class=article-details><h2 class=article-title>pythoné‡ä¿®ä¹‹æ—…ï¼ˆäº”ï¼‰</h2></div></a></article><article><a href=/p/zsh-git-%E6%8F%92%E4%BB%B6%E5%86%85%E7%BD%AE%E5%88%AB%E5%90%8D%E4%B8%80%E8%A7%88%E8%A1%A8/><div class=article-details><h2 class=article-title>zsh git æ’ä»¶å†…ç½®åˆ«åä¸€è§ˆè¡¨</h2></div></a></article><article><a href=/p/%E5%88%A9%E7%94%A8lirc%E5%AF%B9%E6%9D%BE%E4%B8%8B%E7%A9%BA%E8%B0%83%E9%81%A5%E6%8E%A7%E5%99%A8%E6%8C%87%E4%BB%A4%E7%9A%84%E5%BD%95%E5%88%B6/><div class=article-details><h2 class=article-title>åˆ©ç”¨lircå¯¹æ¾ä¸‹ç©ºè°ƒé¥æ§å™¨æŒ‡ä»¤çš„å½•åˆ¶</h2></div></a></article><article><a href=/p/iterm2%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE%E6%80%BB%E7%BB%93/><div class=article-details><h2 class=article-title>iterm2å¸¸ç”¨å¿«æ·é”®æ€»ç»“</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//vic1blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2016 -
2024 ä½•è‚²åç‰ˆæƒæ‰€æœ‰</section><section class=powerby><a href=http://beian.miit.gov.cn>ç²¤ICPå¤‡19031392å·</a><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>